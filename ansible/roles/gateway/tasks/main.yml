# TODO - Need to be able to build this from source for dev environments

- name: "Build {{ container_name }} - {{ build_action }}"
  docker_image:
    name: "{{ image_name }}"
    state: present
    pull: yes
  when: "build_action != ''"

# Creates the docker container for the gateway
- name: Create the {{ container_name }} from image {{ image_name }}
  docker_container:
    name: "{{ container_name }}"
    image: "{{ image_name }}"
    state: started
    networks:
      - name: "{{ docker_network_name }}"          
    exposed_ports: 
    - "443"
    - "80"
    published_ports:
    - "443:443"
    - "80:80"
    links: "{{ link_list }}"
    volumes: 
     - "{{ prepath }}/unfetter/config/nginx/default.conf:/etc/nginx/conf.d/default.conf"
     - "{{ prepath }}/unfetter/config/nginx/conf.d.extra/:/etc/nginx/conf.d.extra"
#     - "{{ prepath }}/unfetter/config/certs/:/etc/pki/tls/certs"
     - "certs:/etc/pki/tls:ro"
  # TAXII
     - "{{ prepath }}/unfetter/config/nginx/{{ 'taxii.conf' if use_taxii else 'taxii-blank.conf' }}:/etc/nginx/conf.d.runmode/taxii.conf"
     - "{{ prepath }}/unfetter/config/nginx/{{ 'taxii-auth.conf' if use_taxii and use_taxii_tls else 'taxii-auth-blank.conf' }}:/etc/nginx/conf.d.runmode/taxii-auth.conf"
   # In UAC
     - "{{ prepath }}/unfetter/config/nginx/{{ 'uac-locations.conf' if use_uac else 'blank.conf' }}:/etc/nginx/conf.d.runmode/runmode-locations.conf"
   # In USE_UNFETTER_UI
     - "{{ prepath }}/unfetter/config/nginx/{{ 'ui-dev.conf' if use_unfetter_ui else 'ui-prod.conf' }}:/etc/nginx/conf.d.runmode/ui.conf"
  when: run_action         

  